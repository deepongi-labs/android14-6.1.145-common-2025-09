name: Build GKI Kernel with KernelSU and SuSFS

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc bison flex libssl-dev libelf-dev \
            libncurses5-dev git wget curl lz4 zstd python3 python3-pip cpio kmod
          
      - name: Setup Custom Toolchain
        run: |
          mkdir -p ${{ github.workspace }}/toolchain
          cd ${{ github.workspace }}/toolchain
          
          wget -q -O clang-toolchain.tar.xz "https://github.com/ZyCromerZ/Clang/releases/download/22.0.0git-20250928-release/Clang-22.0.0git-20250928.tar.gz"
          mkdir -p clang
          tar -xf clang-toolchain.tar.xz -C clang --strip-components=1
          export CLANG_PATH="${{ github.workspace }}/toolchain/clang/bin"
          
          wget -q -O gcc-arm64.tar.xz "https://developer.arm.com/-/media/Files/downloads/gnu/14.3.rel1/binrel/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu.tar.xz"
          tar -xf gcc-arm64.tar.xz
          ARM64_DIR=$(find . -maxdepth 1 -type d -name "*aarch64*" | head -1)
          echo "ARM64_TOOLCHAIN=${{ github.workspace }}/toolchain/${ARM64_DIR}/bin/aarch64-none-linux-gnu-" >> $GITHUB_ENV
          
          wget -q -O gcc-arm32.tar.xz "https://developer.arm.com/-/media/Files/downloads/gnu/14.3.rel1/binrel/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi.tar.xz"
          tar -xf gcc-arm32.tar.xz
          ARM32_DIR=$(find . -maxdepth 1 -type d -name "*arm-none*" | head -1)
          echo "ARM32_TOOLCHAIN=${{ github.workspace }}/toolchain/${ARM32_DIR}/bin/arm-none-eabi-" >> $GITHUB_ENV
          
          if [ -d "clang/bin" ]; then
            export PATH="${{ github.workspace }}/toolchain/clang/bin:$PATH"
            clang --version
          fi

      - name: Clone Kernel Source
        run: |
          git clone --depth=1 --branch=android14-6.1-2025-09 https://android.googlesource.com/kernel/common kernel
          cd kernel
          echo "Kernel version: $(make kernelversion)"

      - name: Integrate KernelSU
        run: |
          cd kernel
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
          echo "KernelSU integrated successfully"

      - name: Clone and Apply SuSFS
        run: |
          git clone --depth=1 --branch=gki-android14-6.1 https://gitlab.com/simonpunk/susfs4ksu.git susfs
          cd kernel
          
          # Copy SuSFS kernel patches
          if [ -d "${{ github.workspace }}/susfs/kernel_patches" ]; then
            cp -r ${{ github.workspace }}/susfs/kernel_patches/* ./
          fi
          
          # Apply SuSFS patches
          if [ -d "${{ github.workspace }}/susfs/kernel_patches/KernelSU" ]; then
            cd KernelSU
            for patch in ${{ github.workspace }}/susfs/kernel_patches/KernelSU/*.patch; do
              if [ -f "$patch" ]; then
                echo "Applying $patch"
                patch -p1 < "$patch" || echo "Patch $patch failed, continuing..."
              fi
            done
            cd ..
          fi
          
          echo "SuSFS integrated successfully"

      - name: Apply Custom Patch 1 (Kernel Root)
        run: |
          cd kernel
          curl -L "https://raw.githubusercontent.com/infectedmushi/kernel_patches/refs/heads/main/fix-clidr-uninitialized.patch" -o patch_0.patch
          patch -p1 < patch_0.patch || echo "Patch 0 failed, continuing..."
          cd ${{ github.workspace }}/kernel
      - name: Configure Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          export CLANG_PATH=${{ github.workspace }}/toolchain/clang/bin
          export PATH="$CLANG_PATH:$PATH"
          export CROSS_COMPILE=${{ env.ARM64_TOOLCHAIN }}
          export PATH="$(dirname ${{ env.ARM64_TOOLCHAIN }}):$PATH"
          export CROSS_COMPILE_COMPAT=${{ env.ARM32_TOOLCHAIN }}
          export PATH="$(dirname ${{ env.ARM32_TOOLCHAIN }}):$PATH"
          
          # Modify defconfig

          echo "CONFIG_LTO_CLANG_THIN=y" >> arch/arm64/configs/gki_defconfig
          echo "# CONFIG_LTO_CLANG_FULL is not set" >> arch/arm64/configs/gki_defconfig
          
          echo "CONFIG_LOCALVERSION=\"-KernelSU-SuSFS\"" >> arch/arm64/configs/gki_defconfig
          
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 gki_defconfig

      - name: Build Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          export CLANG_PATH=${{ github.workspace }}/toolchain/clang/bin
          export PATH="$CLANG_PATH:$PATH"
          export CROSS_COMPILE=${{ env.ARM64_TOOLCHAIN }}
          export PATH="$(dirname ${{ env.ARM64_TOOLCHAIN }}):$PATH"
          export CROSS_COMPILE_COMPAT=${{ env.ARM32_TOOLCHAIN }}
          export PATH="$(dirname ${{ env.ARM32_TOOLCHAIN }}):$PATH"
          
          make -j$(nproc) \
            LLVM_IAS=1 \
            LLVM=1 \
            ARCH=arm64 \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE_COMPAT="$ARM32_TOOLCHAIN" \
            CROSS_COMPILE="$ARM64_TOOLCHAIN" \
            CC=clang \
            LD=ld.lld \
            HOSTLD=ld.lld \
            O=out \
            2>&1 | tee build.log
          
          if [ ! -f out/arch/arm64/boot/Image.gz ] && [ ! -f arch/arm64/boot/Image.gz ]; then
            echo "Kernel build failed!"
            exit 1
          fi
          
          echo "Kernel built successfully"

      - name: Prepare AnyKernel3
        run: |
          git clone --depth=1 --branch=KernelSU https://github.com/deepongi-labs/AnyKernel3-p8a AnyKernel3
          cd AnyKernel3
          rm -rf .git
          
          if [ -f ../kernel/out/arch/arm64/boot/Image.gz ]; then
            cp ../kernel/out/arch/arm64/boot/Image.gz ./
          elif [ -f ../kernel/arch/arm64/boot/Image.gz ]; then
            cp ../kernel/arch/arm64/boot/Image.gz ./
          fi
          
          if [ -f ../kernel/out/arch/arm64/boot/dtbo.img ]; then
            cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          elif [ -f ../kernel/arch/arm64/boot/dtbo.img ]; then
            cp ../kernel/arch/arm64/boot/dtbo.img ./
          fi
          
          if [ -f ../kernel/out/arch/arm64/boot/dtb ]; then
            cp ../kernel/out/arch/arm64/boot/dtb ./
          elif [ -f ../kernel/arch/arm64/boot/dtb ]; then
            cp ../kernel/arch/arm64/boot/dtb ./
          fi

      - name: Package Kernel
        run: |
          cd AnyKernel3
          VERSION="$(cat ../kernel/include/config/kernel.release 2>/dev/null || echo "6.1.145")"
          DATE="$(date +%Y%m%d)"
          ZIP_NAME="GKI-KernelSU-SuSFS-$VERSION-$DATE.zip"
          
          zip -r9 "../$ZIP_NAME" * -x .git README.md ./*placeholder
          cd ..
          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV
          
          echo "âœ… Kernel packaged: $ZIP_NAME"
          ls -lh "$ZIP_NAME"

      - name: Upload Kernel ZIP
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KERNEL_ZIP }}
          path: ${{ env.KERNEL_ZIP }}

      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: Kernel Build ${{ github.run_number }}
          body: |
            ## ðŸŽ‰ GKI Kernel Build
            
            **Kernel Version:** 6.1.145
            **Branch:** android14-6.1-2025-09
            **KernelSU:** Integrated from https://github.com/tiann/KernelSU
            **SuSFS:** Integrated from https://gitlab.com/simonpunk/susfs4ksu.git
            **Toolchain:** Custom
            
            ### Features
            - âœ… KernelSU main
            - âœ… SuSFS gki-android14-6.1
            - âœ… LTO: ThinLTO
            - âœ… Custom defconfig modifications applied
            
            ### Installation
            1. Download the kernel ZIP
            2. Boot to recovery
            3. Flash the ZIP
            4. Reboot and enjoy!
          files: |
            ${{ env.KERNEL_ZIP }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
